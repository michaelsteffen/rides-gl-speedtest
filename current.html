<!DOCTYPE html>
<html>
<head>
	<meta charset='utf-8' />
	<title></title>
	<meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
	<script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.4.2/mapbox-gl.js'></script>
	<script src='https://code.jquery.com/jquery-2.1.1.min.js'></script>
	<link rel='stylesheet' href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.4.0/mapbox-gl.css' />
	<link rel='stylesheet' href='https://cdn.jsdelivr.net/pure/0.5.0/buttons-min.css' />
	<style>
	body { 
		margin: 10px; 
		font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
	}
	#map { position: relative; top: 0; left: 0; height: 500px; margin-bottom: 20px;}
	#controls { }
	.button-bigbutton {
		width: 75%;
		font-size: 125%;
		border-radius: 4px;
		display: block;
		margin-left: auto;
		margin-right: auto;
	}
	</style>
</head>
<body>

<div id='map'></div>
<button id='bigbutton' class='pure-button button-bigbutton pure-button-primary' onclick='doBigButton()'>Play</button>
<h3 id='runtime' style='text-align:center'>Run Time: [hit play to run]</h2>

<script>
mapboxgl.accessToken = 'pk.eyJ1IjoibWFzMjIyIiwiYSI6Ikc2STF6MzAifQ.rRkEFqc17IcaQesSHxUV1w';
var rideMap = {
	rides: getRideList(),
	currentRide: -1,
	mapState: 'clear',
	animStart: 0,
	containerDiv: $('#map'),
	map: new mapboxgl.Map({
		container: 'map',
		center: [29.8752, -95.9683],
		zoom: 9
	})
};

mapboxgl.util.getJSON('rides_electric_base.json', function (err, style) {
	if (err) throw err;
	
	var rideBaseLayers = [];
	var rideTopLayers = [];
	var rideHighlightLayers = [];
	for (var i=0;i<rideMap.rides.length;i++) {
		rideName = rideMap.rides[i];
		rideLayers = createRideLayers(rideName);
		rideBaseLayers.push(rideLayers.baseLayer);
		rideTopLayers.push(rideLayers.topLayer);
		rideHighlightLayers.push(rideLayers.highlightLayer);
	}
	style.layers = style.layers.concat(rideBaseLayers, rideTopLayers, rideHighlightLayers);
	rideMap.map.setStyle(style);
});

rideMap.map.addControl(new mapboxgl.Navigation());

function doBigButton() {
	if (rideMap.mapState == 'clear') {
		rideMap.mapState = 'playing';
		$('#bigbutton')
			.removeClass('pure-button-primary')
			.html('Playing . . .');
		animStart = new Date().getTime();
		showNextRide();
	} else if (rideMap.mapState == 'complete') {
		rideMap.map.style.setClassList([]);
		rideMap.mapState = 'clear';
		rideMap.currentRide = -1;
		$('#bigbutton').html('Play');
	}
}

function showNextRide() {
	if (rideMap.currentRide < rideMap.rides.length - 1) {
	  rideMap.currentRide++;
	  
	  // use getClassList and setClassList to change multiple classes at once 
	  classes = rideMap.map.style.getClassList();	  
		classes.push(rideMap.rides[rideMap.currentRide] + '_active');
		rideMap.map.style.setClassList(classes);
		window.setTimeout(showNextRide, 1);
	} else {
		var animTime = new Date().getTime() - animStart;
		rideMap.mapState = 'complete';
		$('#bigbutton')
			.addClass('pure-button-primary')
			.html('Clear');
		$('#runtime').html("Run Time: " + (animTime/1000).toFixed(1) + " seconds");
	}
}

function createRideLayers(rideName) {
	var baseLayer = {
		"id": rideName,
		"type": "line",
		"source": "vector",
		"source-layer": "ride_gpx_tracks",
		"filter": ["==", "name", rideName],
		"paint": {
			"line-color": "rgb(67, 222, 252)",
			"line-opacity": 0
		}
	};
	
	var topLayer = {
		"id": rideName + "-heat",
		"type": "line",
		"source": "vector",
		"source-layer": "ride_gpx_tracks",
		"filter": ["==", "name", rideName],
		"paint": {
			"line-color": "rgb(255, 255, 255)",
			"line-opacity": 0
		}
	};
	
	var highlightLayer = {
		"id": rideName + "-highlight",
		"type": "line",
		"source": "vector",
		"source-layer": "ride_gpx_tracks",
		"filter": ["==", "name", rideName],
		"paint": {
			"line-color": "rgb(250, 35, 241)",
			"line-width": 3,
			"line-blur": 2,
			"line-opacity": 0
		}
	};
	
	// These have to be added separately since the property name is dynamically generated
	baseLayer["paint." + rideName + "_active"] = {"line-opacity": 0.4}
	topLayer["paint." + rideName + "_active"] = {"line-opacity": 0.1}
	highlightLayer["paint." + rideName + "_highlight"] = {"line-opacity": 1}
	
	return { 
		"baseLayer": baseLayer, 
		"topLayer": topLayer, 
		"highlightLayer": highlightLayer
	};
}

function getRideList() {

	// Obviously this should be read from a json url or something eventually . . .
	return ['2012-11-30T21:11:30Z',
          '2012-12-01T14:24:22Z',
          '2012-12-01T15:39:27Z',
          '2012-12-02T13:45:21Z',
          '2012-12-03T19:43:16Z',
          '2012-12-04T14:12:39Z',
          '2012-12-05T18:08:41Z',
          '2012-12-06T15:08:42Z',
          '2012-12-08T15:50:13Z',
          '2012-12-09T13:36:01Z',
          '2012-12-10T15:43:46Z',
          '2012-12-11T20:19:51Z',
          '2012-12-12T19:41:59Z',
          '2012-12-13T16:03:48Z',
          '2012-12-15T14:44:49Z',
          '2012-12-17T14:06:13Z',
          '2012-12-18T13:51:02Z',
          '2012-12-19T14:09:40Z',
          '2012-12-20T15:57:09Z',
          '2012-12-22T18:40:49Z',
          '2012-12-25T19:40:27Z',
          '2012-12-26T21:50:58Z',
          '2012-12-30T18:41:30Z',
          '2013-01-02T14:14:29Z',
          '2013-01-03T14:01:14Z',
          '2013-01-06T18:15:54Z',
          '2013-01-07T14:12:14Z',
          '2013-01-08T15:49:54Z',
          '2013-01-10T16:08:29Z',
          '2013-01-11T15:34:31Z',
          '2013-01-14T17:31:18Z',
          '2013-01-15T15:22:31Z',
          '2013-01-16T14:20:03Z',
          '2013-01-17T14:15:57Z',
          '2013-01-18T14:01:42Z',
          '2013-01-19T18:38:59Z',
          '2013-01-21T14:35:00Z',
          '2013-01-22T14:21:32Z',
          '2013-01-23T17:12:07Z',
          '2013-01-24T13:59:16Z',
          '2013-01-25T14:19:39Z',
          '2013-01-26T20:54:15Z',
          '2013-01-26T14:12:44Z',
          '2013-01-27T13:47:20Z',
          '2013-01-28T13:57:37Z',
          '2013-01-29T14:11:25Z',
          '2013-01-30T15:22:53Z',
          '2013-01-31T13:59:51Z',
          '2013-02-01T13:54:39Z',
          '2013-02-02T14:30:32Z',
          '2013-02-03T14:24:54Z',
          '2013-02-04T14:20:23Z',
          '2013-02-04T14:11:40Z',
          '2013-02-05T16:12:04Z',
          '2013-02-07T14:31:02Z',
          '2013-02-08T15:24:30Z',
          '2013-02-09T15:38:52Z',
          '2013-02-10T13:30:43Z',
          '2013-02-11T14:17:21Z',
          '2013-02-12T14:11:37Z',
          '2013-02-14T14:13:43Z',
          '2013-02-15T17:40:21Z',
          '2013-02-16T19:32:16Z',
          '2013-02-17T18:18:38Z',
          '2013-02-18T14:35:36Z',
          '2013-02-19T14:13:27Z',
          '2013-02-20T15:14:36Z',
          '2013-02-21T16:43:56Z',
          '2013-02-25T14:21:17Z',
          '2013-02-26T20:14:44Z',
          '2013-02-27T16:34:43Z',
          '2013-03-01T19:36:34Z',
          '2013-03-03T19:04:15Z',
          '2013-03-04T16:01:50Z',
          '2013-03-05T17:00:02Z',
          '2013-03-07T15:46:51Z',
          '2013-03-09T15:27:23Z',
          '2013-03-11T17:48:44Z',
          '2013-03-12T17:54:09Z',
          '2013-03-13T15:41:39Z',
          '2013-03-15T15:10:10Z',
          '2013-03-17T13:10:22Z',
          '2013-03-18T12:53:32Z',
          '2013-03-19T15:18:11Z',
          '2013-03-21T12:55:08Z',
          '2013-03-23T16:09:12Z',
          '2013-03-28T16:53:01Z',
          '2013-03-29T15:07:52Z',
          '2013-03-30T14:35:16Z',
          '2013-04-01T13:30:35Z',
          '2013-04-03T16:51:50Z',
          '2013-04-05T13:27:22Z',
          '2013-04-06T16:47:05Z',
          '2013-04-07T16:56:39Z',
          '2013-04-08T13:07:50Z',
          '2013-04-09T13:01:49Z',
          '2013-04-11T16:33:34Z',
          '2013-04-13T15:55:49Z',
          '2013-04-15T13:11:04Z',
          '2013-04-17T13:13:22Z',
          '2013-04-19T13:03:41Z',
          '2013-04-20T15:57:41Z',
          '2013-04-21T16:57:36Z',
          '2013-04-22T13:13:26Z',
          '2013-04-22T12:53:31Z',
          '2013-04-25T14:00:16Z',
          '2013-04-27T15:58:46Z',
          '2013-04-29T13:42:24Z',
          '2013-05-01T12:47:22Z',
          '2013-05-02T16:26:03Z',
          '2013-05-04T16:52:50Z',
          '2013-05-06T14:15:02Z',
          '2013-05-08T13:05:09Z',
          '2013-05-09T13:09:34Z',
          '2013-05-11T14:33:54Z',
          '2013-05-12T12:36:25Z',
          '2013-05-14T13:36:42Z',
          '2013-05-15T13:06:57Z',
          '2013-05-18T12:08:02Z',
          '2013-05-19T12:13:56Z',
          '2013-05-22T12:44:16Z',
          '2013-05-23T12:49:38Z',
          '2013-05-26T12:25:21Z',
          '2013-05-27T12:27:41Z',
          '2013-05-28T13:04:32Z',
          '2013-05-30T12:57:59Z',
          '2013-06-01T12:27:06Z',
          '2013-06-02T11:45:40Z',
          '2013-06-03T12:50:04Z',
          '2013-06-04T12:51:00Z',
          '2013-06-07T13:08:12Z',
          '2013-06-08T12:10:13Z',
          '2013-06-09T12:32:21Z',
          '2013-06-10T13:17:08Z',
          '2013-06-16T14:02:50Z',
          '2013-06-22T12:45:44Z',
          '2013-06-23T12:00:08Z',
          '2013-06-24T13:04:28Z',
          '2013-06-25T13:01:39Z',
          '2013-06-26T12:53:13Z',
          '2013-06-27T13:03:45Z',
          '2013-06-29T11:34:03Z',
          '2013-06-30T11:23:20Z',
          '2013-07-01T13:01:16Z',
          '2013-07-02T12:45:03Z',
          '2013-07-03T13:06:52Z',
          '2013-07-04T13:21:57Z',
          '2013-07-05T12:11:24Z',
          '2013-07-07T11:51:27Z',
          '2013-07-08T12:49:02Z',
          '2013-07-09T13:01:45Z',
          '2013-07-10T13:07:09Z',
          '2013-07-11T12:43:13Z',
          '2013-07-12T12:43:23Z',
          '2013-07-15T13:13:48Z',
          '2013-07-17T12:38:56Z',
          '2013-07-17T12:57:26Z',
          '2013-07-18T13:08:33Z',
          '2013-07-19T12:54:48Z',
          '2013-07-20T13:08:15Z',
          '2013-07-22T13:01:21Z',
          '2013-07-23T12:49:30Z',
          '2013-07-24T13:07:10Z',
          '2013-07-25T11:51:00Z',
          '2013-07-26T13:03:15Z',
          '2013-07-28T12:36:29Z',
          '2013-07-30T13:01:09Z',
          '2013-07-31T13:13:24Z',
          '2013-08-01T11:48:50Z',
          '2013-08-03T11:38:18Z',
          '2013-08-04T11:47:44Z',
          '2013-08-06T12:59:32Z',
          '2013-08-07T12:53:23Z',
          '2013-08-10T11:47:05Z',
          '2013-08-12T13:02:54Z',
          '2013-08-13T12:41:22Z',
          '2013-08-14T12:55:09Z',
          '2013-08-17T12:15:47Z',
          '2013-08-21T12:13:02Z',
          '2013-08-23T12:10:29Z',
          '2013-08-25T11:56:19Z',
          '2013-08-26T12:43:19Z',
          '2013-08-28T11:50:22Z',
          '2013-08-30T12:29:36Z',
          '2013-09-01T13:22:28Z',
          '2013-09-02T11:37:36Z',
          '2013-09-04T13:24:08Z',
          '2013-09-08T11:57:15Z',
          '2013-09-09T13:18:03Z',
          '2013-09-11T12:33:57Z',
          '2013-09-12T12:44:35Z',
          '2013-09-13T12:45:00Z',
          '2013-09-15T12:01:45Z',
          '2013-09-16T14:17:44Z',
          '2013-09-17T12:43:21Z',
          '2013-09-19T13:07:47Z',
          '2013-09-22T12:11:57Z',
          '2013-09-24T13:25:15Z',
          '2013-09-25T12:59:08Z',
          '2013-09-26T12:45:31Z',
          '2013-09-28T14:02:19Z',
          '2013-09-29T12:41:28Z',
          '2013-09-30T12:10:21Z',
          '2013-10-02T16:05:20Z',
          '2013-10-03T15:56:35Z',
          '2013-10-06T13:00:39Z',
          '2013-10-07T14:39:11Z',
          '2013-10-10T12:41:45Z',
          '2013-10-12T13:31:51Z',
          '2013-10-13T12:32:19Z',
          '2013-10-14T13:30:26Z',
          '2013-10-15T13:15:28Z',
          '2013-10-16T12:41:35Z',
          '2013-10-19T14:17:59Z',
          '2013-10-20T16:14:04Z',
          '2013-10-21T13:35:45Z',
          '2013-10-22T12:46:51Z',
          '2013-10-23T12:06:54Z',
          '2013-10-26T14:43:09Z',
          '2013-10-29T17:56:47Z',
          '2013-11-03T13:25:31Z',
          '2013-11-07T16:06:39Z',
          '2013-11-09T16:04:02Z',
          '2013-11-10T16:34:22Z',
          '2013-11-11T21:22:36Z',
          '2013-11-18T14:18:03Z',
          '2013-11-19T14:02:01Z',
          '2013-12-02T14:27:31Z',
          '2013-12-03T14:00:04Z',
          '2013-12-04T14:16:27Z',
          '2013-12-05T14:12:14Z',
          '2013-12-09T14:18:29Z',
          '2013-12-11T14:04:37Z',
          '2013-12-12T14:03:07Z',
          '2013-12-13T14:08:33Z',
          '2013-12-15T14:30:00Z',
          '2013-12-16T13:58:33Z',
          '2013-12-17T13:56:21Z',
          '2013-12-19T14:08:07Z',
          '2014-01-02T14:33:39Z',
          '2014-01-03T14:13:25Z',
          '2014-01-04T18:32:46Z',
          '2014-01-08T14:20:18Z',
          '2014-01-09T14:00:08Z',
          '2014-01-10T14:14:32Z',
          '2014-01-11T16:41:44Z',
          '2014-01-12T18:06:36Z',
          '2014-01-13T14:07:10Z',
          '2014-01-14T14:25:26Z',
          '2014-01-15T14:00:25Z',
          '2014-01-16T14:02:40Z',
          '2014-01-18T18:33:04Z',
          '2014-01-19T18:20:11Z',
          '2014-01-20T18:29:44Z',
          '2014-01-21T14:06:04Z',
          '2014-01-22T14:25:12Z',
          '2014-01-23T14:01:54Z',
          '2014-01-25T20:59:09Z',
          '2014-01-26T17:24:13Z',
          '2014-01-27T13:56:28Z',
          '2014-01-30T19:55:58Z',
          '2014-01-31T14:00:26Z',
          '2014-02-01T15:08:46Z',
          '2014-02-03T21:52:20Z',
          '2014-02-05T13:58:22Z',
          '2014-02-07T16:14:44Z',
          '2014-02-08T21:33:29Z',
          '2014-02-10T13:41:32Z',
          '2014-02-09T20:56:23Z',
          '2014-02-12T21:05:08Z',
          '2014-02-13T17:44:46Z',
          '2014-02-14T17:21:46Z',
          '2014-02-21T13:56:08Z',
          '2014-02-22T18:07:36Z',
          '2014-02-23T18:41:21Z',
          '2014-02-24T14:20:48Z',
          '2014-02-24T15:44:59Z',
          '2014-02-25T13:51:39Z',
          '2014-02-27T18:58:35Z',
          '2014-02-28T14:04:00Z',
          '2014-03-01T17:30:21Z',
          '2014-03-02T13:18:40Z',
          '2014-03-03T20:51:18Z',
          '2014-03-05T18:50:42Z',
          '2014-03-06T16:53:05Z',
          '2014-03-07T13:52:28Z',
          '2014-03-08T15:37:42Z',
          '2014-03-10T13:09:43Z',
          '2014-03-11T13:03:59Z',
          '2014-03-12T12:40:04Z',
          '2014-03-13T13:10:19Z',
          '2014-03-17T13:03:55Z',
          '2014-03-18T13:02:12Z',
          '2014-03-19T12:55:36Z',
          '2014-03-20T18:58:51Z',
          '2014-03-21T12:51:29Z',
          '2014-03-22T15:15:54Z',
          '2014-03-24T13:04:06Z',
          '2014-03-25T12:51:58Z',
          '2014-03-26T12:53:36Z',
          '2014-03-27T12:59:47Z',
          '2014-03-28T12:51:54Z',
          '2014-03-29T13:42:00Z',
          '2014-03-30T12:00:56Z',
          '2014-03-31T13:04:07Z',
          '2014-04-01T12:37:43Z',
          '2014-04-02T13:02:04Z',
          '2014-04-03T13:07:58Z',
          '2014-04-07T13:05:51Z',
          '2014-04-07T19:08:23Z',
          '2014-04-08T12:55:59Z',
          '2014-04-09T13:10:07Z',
          '2014-04-10T13:01:30Z',
          '2014-04-16T17:04:51Z',
          '2014-04-17T17:59:04Z',
          '2014-04-18T13:21:52Z',
          '2014-04-19T14:49:22Z',
          '2014-04-20T11:52:15Z',
          '2014-04-22T12:41:36Z',
          '2014-04-23T13:04:37Z',
          '2014-04-24T14:03:13Z',
          '2014-04-26T15:29:06Z',
          '2014-04-27T12:09:48Z',
          '2014-04-28T12:44:12Z',
          '2014-04-30T12:39:57Z',
          '2014-05-01T13:59:05Z',
          '2014-05-03T20:14:04Z',
          '2014-05-04T11:49:24Z',
          '2014-05-07T14:07:55Z',
          '2014-05-08T12:57:21Z',
          '2014-05-09T12:39:15Z',
          '2014-05-11T11:48:32Z',
          '2014-05-13T15:52:12Z',
          '2014-05-15T13:05:45Z',
          '2014-05-17T14:01:37Z',
          '2014-05-18T11:50:53Z',
          '2014-05-19T12:59:07Z',
          '2014-05-21T12:55:42Z',
          '2014-05-22T13:53:26Z',
          '2014-05-24T13:46:52Z',
          '2014-05-25T11:51:31Z',
          '2014-05-28T13:04:29Z',
          '2014-05-29T16:56:24Z',
          '2014-05-31T12:29:56Z',
          '2014-06-01T12:05:27Z',
          '2014-06-02T12:37:14Z',
          '2014-06-04T12:41:48Z',
          '2014-06-05T12:48:28Z',
          '2014-06-09T13:26:15Z',
          '2014-06-11T17:29:21Z',
          '2014-06-15T13:24:55Z',
          '2014-06-10T13:20:38Z',
          '2014-06-12T19:58:43Z',
          '2014-06-08T21:09:17Z',
          '2014-06-14T16:21:34Z',
          '2014-06-18T12:51:57Z',
          '2014-06-18T14:01:47Z',
          '2014-06-19T13:10:18Z',
          '2014-06-21T10:57:42Z',
          '2014-06-23T11:46:56Z',
          '2014-06-24T12:01:04Z',
          '2014-06-27T13:01:44Z',
          '2014-06-29T11:50:16Z',
          '2014-06-30T13:02:00Z',
          '2014-07-01T12:59:48Z',
          '2014-07-03T13:00:00Z',
          '2014-07-04T12:20:10Z',
          '2014-07-05T14:22:32Z',
          '2014-07-07T13:13:36Z',
          '2014-07-08T14:52:58Z',
          '2014-07-09T12:49:49Z',
          '2014-07-11T12:41:40Z',
          '2014-07-12T12:27:54Z',
          '2014-07-14T13:16:28Z',
          '2014-07-16T12:31:35Z',
          '2014-07-17T12:31:36Z',
          '2014-07-18T12:44:14Z',
          '2014-07-19T14:20:00Z',
          '2014-07-20T11:31:48Z',
          '2014-07-21T12:54:53Z',
          '2014-07-22T12:48:34Z',
          '2014-07-23T17:51:04Z',
          '2014-07-24T12:56:29Z',
          '2014-07-25T12:49:42Z',
          '2014-07-26T13:28:30Z',
          '2014-07-27T11:45:22Z',
          '2014-07-28T12:41:18Z',
          '2014-07-30T12:29:53Z',
          '2014-07-31T12:39:41Z',
          '2014-08-02T12:41:39Z',
          '2014-08-03T12:09:35Z',
          '2014-08-08T13:04:08Z',
          '2014-08-10T11:30:38Z',
          '2014-08-11T12:23:16Z',
          '2014-08-13T12:53:19Z',
          '2014-08-14T11:52:13Z',
          '2014-08-16T12:13:50Z',
          '2014-08-17T12:21:39Z',
          '2014-08-19T12:56:04Z',
          '2014-08-20T12:51:29Z',
          '2014-08-21T12:00:54Z',
          '2014-08-23T12:27:38Z',
          '2014-08-25T12:39:55Z',
          '2014-08-26T12:31:05Z',
          '2014-08-30T13:03:55Z',
          '2014-08-31T12:39:37Z',
          '2014-09-01T12:38:04Z',
          '2014-09-02T13:38:14Z',
          '2014-09-04T12:29:13Z',
          '2014-09-07T11:02:52Z',
          '2014-09-09T12:33:32Z',
          '2014-09-11T13:03:25Z',
          '2014-09-14T12:02:48Z',
          '2014-09-16T12:49:38Z',
          '2014-09-17T12:29:36Z',
          '2014-09-18T12:17:18Z',
          '2014-09-21T12:12:32Z',
          '2014-09-24T12:55:01Z',
          '2014-09-25T14:33:26Z',
          '2014-09-26T14:13:36Z',
          '2014-09-26T13:08:16Z',
          '2014-10-19T13:32:51Z',
          '2014-10-06T17:48:50Z',
          '2014-10-02T19:42:49Z',
          '2014-09-29T18:39:46Z',
          '2014-10-20T13:12:04Z',
          '2014-10-21T13:03:14Z',
          '2014-10-23T12:27:35Z',
          '2014-10-24T12:27:48Z',
          '2014-10-26T13:04:57Z',
          '2014-10-28T15:10:44Z',
          '2014-10-29T12:57:17Z',
          '2014-10-30T12:47:40Z',
          '2014-10-31T12:58:08Z',
          '2014-11-01T16:43:08Z',
          '2014-11-02T13:39:47Z',
          '2014-11-04T13:49:19Z'];
}
</script>
</body>
</html>
